# Main 分支构建 - 生成 Linux amd64 二进制，供服务器直接运行
# 不依赖 Docker，服务器只需运行二进制即可
name: Build Main (Linux amd64)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build Linux amd64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Determine Version
        id: version
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          VERSION="main-$(date +'%Y%m%d')-${SHORT_SHA}"
          echo "$VERSION" > VERSION
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "value=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.22'

      - name: Build Backend (Linux amd64)
        run: |
          go mod download
          go build -ldflags "-s -w -X 'github.com/QuantumNous/new-api/common.Version=$VERSION'" -o new-api

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: new-api-linux-amd64
          path: new-api
