# æ„å»º + éƒ¨ç½²ï¼šåˆ†æ­¥æ‰§è¡Œï¼Œå¯æŸ¥çœ‹è¿›åº¦ï¼Œæ„å»ºå®Œæˆåè‡ªåŠ¨éƒ¨ç½²
# éœ€åœ¨ GitHub ä»“åº“ Settings â†’ Secrets é…ç½®ï¼š
#   DEPLOY_HOST=47.237.158.148
#   DEPLOY_USER=root
#   DEPLOY_PASSWORD=foxrouter@1234
# è‹¥ä½¿ç”¨ SSH ç§é’¥å¯é…ç½® DEPLOY_SSH_KEY æ›¿ä»£å¯†ç 

name: Build & Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: 1ï¸âƒ£ æ„å»º
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION="main-$(date +'%Y%m%d')-${GITHUB_SHA::7}"
          echo "$VERSION" > VERSION
          echo "value=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Version: $VERSION"

      - name: æ„å»ºå‰ç«¯
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=${{ steps.version.outputs.value }} bun run build
          cd ..

      - name: æ„å»ºåç«¯
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.22'
      - run: |
          go mod download
          go build -ldflags "-s -w -X 'github.com/QuantumNous/new-api/common.Version=${{ steps.version.outputs.value }}'" -o new-api

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: new-api-binary
          path: new-api

  deploy:
    name: 2ï¸âƒ£ éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: new-api-binary

      - name: ä¸Šä¼ å¹¶é‡å¯æœåŠ¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "new-api"
          target: "/root/new-api/"
          strip_components: 0
          rm: false

      - name: é‡å¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            cd /root/new-api
            chmod +x new-api
            systemctl restart new-api
            sleep 2
            systemctl status new-api --no-pager || true
            curl -sf http://localhost:3000/api/status | head -c 200 && echo "" || echo "âš ï¸ API å°šæœªå°±ç»ªï¼Œè¯·ç¨åæ£€æŸ¥"
